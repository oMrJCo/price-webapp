// price.js — PDF Renderer for LEEPLUS (Using pdf.js)

let pdfDoc = null;
let scale = 1.5; // ค่าเริ่มต้นสำหรับการขยาย
const pdfHost = document.getElementById('pdfHost');
const statusText = document.getElementById('statusText');

/**
 * 1. ดึงข้อมูลจาก URL (title และ pdf path)
 */
const params = new URLSearchParams(window.location.search);
const title = params.get('title') || 'ราคาสินค้า';
const pdfPath = params.get('pdf');

document.getElementById('pageTitle').textContent = title;
document.getElementById('pdfPathBadge').textContent = `ไฟล์: ${pdfPath.split('/').pop()}`;

// ตั้งค่าปุ่มย้อนกลับ
document.getElementById('backBtn').onclick = () => history.back();

// ตั้งค่าปุ่มเปิด PDF แยก (เผื่อลูกค้าอยากโหลดเก็บไว้)
document.getElementById('openPdfBtn').onclick = () => window.open(pdfPath, '_blank');

/**
 * 2. ฟังก์ชันเรนเดอร์ PDF ทุกหน้า
 */
async function renderPDF() {
    if (!pdfPath) {
        pdfHost.innerHTML = '<div class="err">ไม่พบไฟล์ PDF กรุณาย้อนกลับไปเลือกใหม่</div>';
        return;
    }

    try {
        statusText.textContent = "กำลังโหลดไฟล์...";
        const loadingTask = pdfjsLib.getDocument(pdfPath);
        pdfDoc = await loadingTask.promise;
        statusText.textContent = `โหลดเสร็จแล้ว (${pdfDoc.numPages} หน้า)`;
        
        renderAllPages();
    } catch (err) {
        console.error(err);
        pdfHost.innerHTML = `<div class="err">เกิดข้อผิดพลาดในการโหลด PDF<br><a href="${pdfPath}">คลิกที่นี่เพื่อเปิดไฟล์ตรงๆ</a></div>`;
    }
}

async function renderAllPages() {
    pdfHost.innerHTML = ''; // ล้างค่าเก่าก่อนเรนเดอร์ใหม่เวลาซูม
    for (let num = 1; num <= pdfDoc.numPages; num++) {
        await renderPage(num);
    }
}

async function renderPage(num) {
    const page = await pdfDoc.getPage(num);
    const viewport = page.getViewport({ scale: scale });
    
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.height = viewport.height;
    canvas.width = viewport.width;
    
    pdfHost.appendChild(canvas);
    
    await page.render({ canvasContext: ctx, viewport: viewport }).promise;
}

/**
 * 3. ระบบซูม (Zoom Controls)
 */
document.getElementById('zoomInBtn').onclick = () => {
    scale += 0.25;
    renderAllPages();
};

document.getElementById('zoomOutBtn').onclick = () => {
    if (scale <= 0.5) return;
    scale -= 0.25;
    renderAllPages();
};

document.getElementById('fitBtn').onclick = () => {
    scale = 1.0;
    renderAllPages();
};

// เริ่มทำงาน
if (pdfPath) {
    renderPDF();
}

// จัดการปุ่ม LINE Floating
const fab = document.getElementById("lineFab");
const qrBox = document.getElementById("qrBox");
if (fab && qrBox) {
    fab.onclick = (e) => {
        e.stopPropagation();
        qrBox.classList.toggle("show");
    };
    document.addEventListener("click", () => qrBox.classList.remove("show"));
}