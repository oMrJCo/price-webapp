<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ตั้งรหัสผ่านใหม่ | LEEPLUS</title>
  <style>
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",sans-serif;background:#f6f7f9;color:#111;}
    .wrap{max-width:520px;margin:0 auto;padding:28px 18px;}
    .card{background:#fff;border:1px solid #eee;border-radius:16px;padding:18px;}
    h1{font-size:20px;margin:0 0 10px;font-weight:800;}
    p{margin:0 0 12px;color:#555;font-size:13px;line-height:1.4;}
    label{display:block;font-size:13px;margin:12px 0 6px;color:#333;font-weight:700;}
    input{width:100%;padding:12px 12px;border:1px solid #ddd;border-radius:12px;font-size:14px;outline:none;}
    button{margin-top:14px;width:100%;padding:12px 14px;border:0;border-radius:12px;background:#111;color:#fff;font-weight:800;cursor:pointer;}
    .note{margin-top:12px;font-size:12px;color:#666}
    .ok{margin-top:12px;padding:10px 12px;border-radius:12px;background:#eaffea;border:1px solid #bde8bd;color:#1b6b1b;font-size:13px}
    .err{margin-top:12px;padding:10px 12px;border-radius:12px;background:#ffecec;border:1px solid #f3b2b2;color:#8a1f1f;font-size:13px;white-space:pre-wrap}
    .small{font-size:12px;color:#777;margin-top:8px}
    .link{display:inline-block;margin-top:10px;font-size:13px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>ตั้งรหัสผ่านใหม่</h1>
      <p>หน้านี้ใช้สำหรับตั้งรหัสผ่าน Netlify Identity หลังจากกด Reset password จากอีเมลค่ะ</p>

      <div id="msg"></div>

      <label>รหัสผ่านใหม่</label>
      <input id="pw" type="password" placeholder="อย่างน้อย 8 ตัวอักษร" />

      <label>ยืนยันรหัสผ่าน</label>
      <input id="pw2" type="password" placeholder="พิมพ์ซ้ำอีกครั้ง" />

      <button id="btn">ตั้งรหัสผ่าน</button>

      <div class="note">
        ถ้าตั้งสำเร็จ ให้ไปหน้า <a class="link" href="/admin/">/admin</a> แล้ว Login ได้เลย
      </div>

      <div class="small" id="tokenInfo"></div>
    </div>
  </div>

<script>
  const msg = document.getElementById('msg');
  const pw = document.getElementById('pw');
  const pw2 = document.getElementById('pw2');
  const btn = document.getElementById('btn');
  const tokenInfo = document.getElementById('tokenInfo');

  // Netlify ส่ง token มาใน hash: #recovery_token=xxxx
  const hash = new URLSearchParams(location.hash.replace('#',''));
  const token = hash.get('recovery_token');

  function show(type, text){
    msg.innerHTML = type === 'ok'
      ? `<div class="ok">${text}</div>`
      : `<div class="err">${text}</div>`;
  }

  if (!token){
    show('err', 'ไม่พบ recovery_token\n\nวิธีแก้:\n1) กด Reset password ใหม่จาก Netlify\n2) ในอีเมลให้เปิดลิงก์นั้น แล้วระบบควรพามาหน้านี้พร้อม token');
  } else {
    tokenInfo.textContent = 'Token พร้อมแล้ว ✅';
  }

  async function recover(){
    if (!token) return;
    const a = pw.value || '';
    const b = pw2.value || '';
    if (a.length < 8) return show('err', 'รหัสผ่านควรยาวอย่างน้อย 8 ตัวอักษร');
    if (a !== b) return show('err', 'รหัสผ่านทั้งสองช่องไม่ตรงกัน');

    btn.disabled = true;
    btn.textContent = 'กำลังตั้งรหัสผ่าน...';

    try{
      const res = await fetch('/.netlify/identity/recover', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ token, password: a })
      });

      const data = await res.json().catch(()=> ({}));

      if (!res.ok){
        const detail = data && (data.msg || data.message || JSON.stringify(data));
        throw new Error(detail || ('HTTP ' + res.status));
      }

      show('ok', 'ตั้งรหัสผ่านสำเร็จ ✅\nไปที่ /admin แล้ว Login ได้เลยค่ะ');
      btn.textContent = 'ตั้งรหัสผ่านสำเร็จ';
    }catch(e){
      show('err', 'ตั้งรหัสผ่านไม่สำเร็จ\n\n' + (e?.message || e));
      btn.disabled = false;
      btn.textContent = 'ตั้งรหัสผ่าน';
    }
  }

  btn.addEventListener('click', recover);
</script>
</body>
</html>
